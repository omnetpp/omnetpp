%description:
Stress test for gate manipulation: create, delete, set size, etc.
Also tests all gate access functions in cModule (positive test cases only).

%file: test.ned

simple Node
{
}

network Test
{
    submodules:
        node: Node;
}

%file: test.cc

#include <omnetpp.h>

namespace {} {

class Node : public cSimpleModule
{
  private:
    int counter;
    std::set<std::string> createdNames;
    std::set<std::string> currentNames;
    std::set<std::string> deletedNames;
    int numGates; // total gate count

  public:
    Node() : cSimpleModule(16384) { }
    virtual void activity();
    void createRandomGate();
    void deleteRandomGate();
    void setRandomGateSize();
    void testGateIterator();
    void createTestGate(const char *gatename, cGate::Type type, bool isVector);
    void checkOneGate(const char *gatename, cGate::Type type, int size=-1, int index=-1);
    void deleteTestGate(const char *gatename);
    void setTestGateSize(const char *gatename, int size);
    std::string chooseRandom(const std::set<std::string>& names);
};

Define_Module(Node);

void Node::createTestGate(const char *gatename, cGate::Type type, bool isVector)
{
    ev << "creating " << gatename << (isVector?"[]":"") << "\n";

    addGate(gatename, type, isVector);

    if (!isVector)
        numGates += (type==cGate::INOUT) ? 2 : 1;

    createdNames.insert(gatename);
    currentNames.insert(gatename);

    if (type==cGate::INOUT) {
        ASSERT(gateType(gatename)==type);
        checkOneGate((std::string(gatename)+"$i").c_str(), cGate::INPUT, isVector ? 0 : -1);
        checkOneGate((std::string(gatename)+"$o").c_str(), cGate::OUTPUT, isVector ? 0 : -1);
    }
    else {
        checkOneGate(gatename, type, isVector ? 0 : -1);
    }
}

void Node::checkOneGate(const char *gatename, cGate::Type type, int size, int index)
{
    ASSERT(type!=cGate::INOUT);

    // TODO assert that gateNames() contains gatename (less $i/$o)
    ASSERT(hasGate(gatename));
    ASSERT(gateType(gatename)==type);
    ASSERT(isGateVector(gatename)==(size!=-1));
    ASSERT(gateSize(gatename)==(size!=-1 ? size : 1));

    if (size!=0) {
        ASSERT(hasGate(gatename, index));
        cGate *g = gate(gatename, index);
        ASSERT(g != NULL);
        int id = g->id();
        ASSERT(findGate(gatename, index) == id);
        ASSERT(gate(id) == g);
        ASSERT(g->name() == std::string(gatename));
        ASSERT(g->type() == type);

        if (size>0) { // is vector
            ASSERT(g->index() == index);
            ASSERT(g->size() == size);
        }

        if (strchr(gatename, '$')) {
            std::string basename = std::string(gatename, strlen(gatename)-2);
            ASSERT(gateHalf(basename.c_str(),type,index) == g);
        }
    }
}

void Node::createRandomGate()
{
    char gatename[30];
    sprintf(gatename, "gate%d", counter++);

    switch (intrand(6)) {
      case 0: createTestGate(gatename, cGate::INPUT,  false); break;
      case 1: createTestGate(gatename, cGate::OUTPUT, false); break;
      case 2: createTestGate(gatename, cGate::INOUT,  false); break;
      case 3: createTestGate(gatename, cGate::INPUT,  true); break;
      case 4: createTestGate(gatename, cGate::OUTPUT, true); break;
      case 5: createTestGate(gatename, cGate::INOUT,  true); break;
    }
}

void Node::deleteRandomGate()
{
    if (!currentNames.empty()) {
        std::string gatename = chooseRandom(currentNames);
        deleteTestGate(gatename.c_str());
    }
}

void Node::deleteTestGate(const char *gatename)
{
    ev << "deleting " << gatename << (isGateVector(gatename)?"[]":"") << "\n";

    int size = isGateVector(gatename) ? gateSize(gatename) : 1;
    numGates -= size * (gateType(gatename)==cGate::INOUT ? 2 : 1);
    deleteGate(gatename);
    currentNames.erase(gatename);
    deletedNames.insert(gatename);

    ASSERT(hasGate(gatename) == false);
}

void Node::setRandomGateSize()
{
    if (!currentNames.empty()) {
        std::string gatename = chooseRandom(currentNames);
        if (isGateVector(gatename.c_str()))
            setTestGateSize(gatename.c_str(), exponential(5));

        // again
        gatename = chooseRandom(currentNames);
        if (isGateVector(gatename.c_str()))
            setTestGateSize(gatename.c_str(), exponential(30));
    }
}

void Node::setTestGateSize(const char *gatename, int size)
{
    ev << "resizing " << gatename << "[" << gateSize(gatename) << "] to [" << size << "]\n";

    cGate::Type type = gateType(gatename);
    int oldSize = gateSize(gatename);
    setGateSize(gatename, size);
    numGates += (type==cGate::INOUT ? 2 : 1) * (size - oldSize);

    ASSERT(gateSize(gatename)==size);
    ASSERT(gateSize(gatename)==size);

    for (int i=0; i<size; i++) {
        if (type==cGate::INOUT) {
            checkOneGate((std::string(gatename)+"$i").c_str(), cGate::INPUT, size, i);
            checkOneGate((std::string(gatename)+"$o").c_str(), cGate::OUTPUT, size, i);
        }
        else {
            checkOneGate(gatename, type, size, i);
        }
    }
}

void Node::testGateIterator()
{
    ASSERT(numGates == gateCount());

    int n = 0;
    std::set<cGate *> visited;
    for (GateIterator i(this); !i.end(); i++) {
        cGate *g = i();
        ASSERT(g!=NULL);
        ASSERT(gate(g->id()) == g);
        ASSERT(visited.count(g)==0);
        visited.insert(g);
        ASSERT(visited.count(g)==1);
        n++;
    }
    ASSERT(n == numGates);
}

std::string Node::chooseRandom(const std::set<std::string>& names)
{
    int k = intrand(names.size());
    std::set<std::string>::const_iterator it = names.begin();
    for (int i=0; i<k; i++)
        it++;
    return *it;
}

void Node::activity()
{
    counter = 0;
    numGates = 0;
    for (int i=0; i<100; i++)
    {
        //random: create/delete/setsize/connect/unconnect/++
        switch (intrand(3)) {
            case 0: createRandomGate(); break;
            case 1: deleteRandomGate(); break;
            case 2: setRandomGateSize(); break;
        }
        testGateIterator();
    }
    ev << "done.\n";
}


}; //namespace

%inifile: test.ini
[General]
network = Test
debug-on-errors = true
cmdenv-express-mode = false

%contains: stdout
creating gate0[]
creating gate1[]
deleting gate1[]
deleting gate0[]
creating gate2
creating gate3[]
resizing gate3[0] to [1]
resizing gate3[1] to [19]
resizing gate3[19] to [2]
deleting gate3[]
creating gate4
creating gate5[]
creating gate6[]
deleting gate5[]
creating gate7
creating gate8
deleting gate7
deleting gate4
deleting gate2
resizing gate6[0] to [3]
resizing gate6[3] to [23]
creating gate9
creating gate10
creating gate11[]
deleting gate10
creating gate12
creating gate13
resizing gate11[0] to [3]
deleting gate12
deleting gate8
resizing gate6[23] to [10]
resizing gate11[3] to [34]
deleting gate11[]
deleting gate9
creating gate14[]
creating gate15[]
creating gate16[]
creating gate17[]
creating gate18
resizing gate17[0] to [7]
resizing gate15[0] to [55]
deleting gate18
deleting gate13
deleting gate15[]
creating gate19[]
resizing gate14[0] to [2]
resizing gate17[7] to [11]
resizing gate14[2] to [0]
resizing gate19[0] to [22]
resizing gate14[0] to [2]
resizing gate16[0] to [117]
creating gate20
resizing gate19[22] to [10]
resizing gate19[10] to [63]
deleting gate17[]
resizing gate6[10] to [39]
resizing gate16[117] to [2]
deleting gate6[]
resizing gate19[63] to [5]
resizing gate14[2] to [12]
resizing gate14[12] to [10]
resizing gate14[10] to [6]
resizing gate19[5] to [2]
resizing gate14[6] to [54]
creating gate21[]
resizing gate14[54] to [1]
resizing gate19[2] to [39]
resizing gate19[39] to [6]
resizing gate14[1] to [41]
creating gate22[]
creating gate23
resizing gate14[41] to [7]
creating gate24[]
resizing gate14[7] to [0]
deleting gate20
creating gate25[]
deleting gate23
creating gate26
creating gate27[]
deleting gate14[]
creating gate28
resizing gate25[0] to [0]
resizing gate22[0] to [13]
creating gate29
creating gate30[]
deleting gate26
deleting gate28
creating gate31
deleting gate21[]
creating gate32[]
resizing gate32[0] to [2]
creating gate33
deleting gate31
resizing gate24[0] to [5]
resizing gate27[0] to [1]
resizing gate16[2] to [69]
creating gate34[]
resizing gate27[1] to [57]
creating gate35
resizing gate24[5] to [53]
deleting gate24[]
resizing gate27[57] to [4]
resizing gate25[0] to [26]
deleting gate34[]
deleting gate32[]
resizing gate22[13] to [0]
resizing gate25[26] to [0]
deleting gate33
deleting gate29
deleting gate27[]
resizing gate22[0] to [3]
resizing gate19[6] to [32]
creating gate36[]
done.

