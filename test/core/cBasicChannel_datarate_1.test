%description:
Test channel data rate

%file: test.ned

channel MyConn extends ned.BasicChannel
{
    parameters:
        datarate = 1e5bps;
        delay = 0.1s;
}

simple Node1
{
    gates:
        output out;
}

simple Node2
{
    gates:
        input in;
}

network Test
{
    submodules:
        node1: Node1;
        node2: Node2;
    connections:
        node1.out --> MyConn --> node2.in;
}

%file: test.cc

#include <omnetpp.h>

namespace {} {

class Node1 : public cSimpleModule
{
  public:
    Node1() : cSimpleModule(16384) { }
    virtual void activity();
};

Define_Module(Node1);

#define PRINTGATESTATE()  ev << "t=" << simTime() << ": busy:" << g->isBusy() << ", finishes:" << g->getTransmissionFinishTime() << endl;

void Node1::activity()
{
    cMessage *msg;
    cGate *g = gate("out");

    PRINTGATESTATE();

    wait(1.0);

    PRINTGATESTATE();

    msg = new cMessage("msg1");
    msg->setLength(500);
    send(msg, g);

    PRINTGATESTATE();

    wait(1.0);
    PRINTGATESTATE();

    msg = new cMessage("msg2");
    msg->setLength(300);
    send(msg, g);

    PRINTGATESTATE();
    wait(0.004);
    PRINTGATESTATE();

    msg = new cMessage("msg3");
    msg->setLength(200);
    send(msg, g);

    wait(0.002);
    PRINTGATESTATE();

    wait(1.0);
    PRINTGATESTATE();
}

class Node2 : public cSimpleModule
{
  public:
    Node2() : cSimpleModule(16384) { }
    virtual void activity();
};

Define_Module(Node2);


void Node2::activity()
{
    for (;;)
    {
        cMessage *msg = receive();
        ev << "t=" << simTime() << ": " << msg->getName() << " arrived" << endl;
        delete msg;
    }
}

}; //namespace

%inifile: test.ini
[General]
network = Test
cmdenv-express-mode = false
cmdenv-event-banners = false

%contains: stdout
t=0: busy:0, finishes:0
t=1: busy:0, finishes:0
t=1: busy:1, finishes:1.005
t=1.105: msg1 arrived
t=2: busy:0, finishes:1.005
t=2: busy:1, finishes:2.003
t=2.004: busy:0, finishes:2.003
t=2.006: busy:0, finishes:2.006
t=2.103: msg2 arrived
t=2.106: msg3 arrived
t=3.006: busy:0, finishes:2.006
